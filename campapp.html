<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampCount éœ²ç‡Ÿå¸³å‹™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; border: none; shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .balance-positive { color: #198754; font-weight: bold; }
        .balance-negative { color: #dc3545; font-weight: bold; }
        .btn-x { padding: 0px 8px; font-size: 0.8rem; }
        
        /* éæœŸæ´»å‹•çš„æ¨£å¼ */
        .trip-finished {
            background-color: #e9ecef !important; /* ç°è‰²èƒŒæ™¯ */
            color: #6c757d !important; /* ç°è‰²æ–‡å­— */
            border-left: 5px solid #6c757d !important;
        }
        .trip-finished .badge-status {
            background-color: #6c757d !important;
        }
        .trip-active {
            border-left: 5px solid #198754; /* é€²è¡Œä¸­æ˜¯ç¶ è‰²é‚Šæ¢ */
        }
    </style>
</head>
<body>

<div class="container py-4" style="max-width: 800px;">
    <h2 class="text-center mb-4 fw-bold text-success">â›º CampCount éœ²ç‡Ÿå¸³å‹™ <small class="text-muted fs-6">V3</small></h2>

    <div id="page-list">
        <div class="card p-4 shadow-sm">
            <h5 class="mb-3">ğŸ“… å»ºç«‹æ–°éœ²ç‡Ÿæ´»å‹•</h5>
            <div class="row g-2">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">èµ·</span>
                        <input type="date" id="newStartDate" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">è¿„</span>
                        <input type="date" id="newEndDate" class="form-control">
                    </div>
                </div>
                <div class="col-md-12">
                    <input type="text" id="newLoc" class="form-control" placeholder="åœ°é» (ä¾‹ï¼šè‹—æ —æ˜Ÿç©ºç‡Ÿå€)">
                </div>
                <div class="col-md-12">
                    <button onclick="createTrip()" class="btn btn-primary w-100 fw-bold">å»ºç«‹æ´»å‹•</button>
                </div>
            </div>
        </div>
        
        <h5 class="mt-4 mb-3 ps-2 border-start border-4 border-secondary">æ­·å²æ´»å‹•ç´€éŒ„</h5>
        <div id="tripList" class="list-group shadow-sm"></div>
        <div id="loading" class="text-center mt-3 text-muted">è¼‰å…¥è³‡æ–™ä¸­...</div>
    </div>

    <div id="page-detail" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button onclick="showList()" class="btn btn-outline-secondary">â† è¿”å›åˆ—è¡¨</button>
            <button onclick="deleteCurrentTrip()" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸ åˆªé™¤æ­¤æ´»å‹•</button>
        </div>
        
        <h3 id="detailTitle" class="fw-bold mb-1"></h3>
        <p id="detailDate" class="text-muted mb-4"></p>
        
        <div class="row">
            <div class="col-md-5">
                <div class="card p-3">
                    <h6 class="fw-bold text-secondary">ğŸ‘¥ 1. åƒåŠ äººå“¡</h6>
                    <div class="input-group mb-2">
                        <input type="text" id="newPerson" class="form-control" placeholder="å§“å">
                        <button onclick="addParticipant()" class="btn btn-outline-primary">+</button>
                    </div>
                    <div id="participantList" class="d-flex flex-wrap gap-1"></div>
                </div>

                <div class="card p-3">
                    <h6 class="fw-bold text-secondary">ğŸ’° 2. æ–°å¢æ”¯å‡º</h6>
                    <input type="text" id="expItem" class="form-control mb-2" placeholder="é …ç›® (å¦‚: é£Ÿæ)">
                    <input type="number" id="expCost" class="form-control mb-2" placeholder="é‡‘é¡">
                    <select id="expPayer" class="form-select mb-2"><option>èª°ä»˜éŒ¢?</option></select>
                    <button onclick="addExpense()" class="btn btn-success w-100">æ–°å¢ç´€éŒ„</button>
                </div>

                <div class="card p-3">
                    <h6 class="fw-bold text-secondary">â›º 3. å…¬ç”¨è£å‚™</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="gearItem" class="form-control" style="flex: 2;" placeholder="è£å‚™åç¨±">
                        <input type="number" id="gearQty" class="form-control" style="flex: 1;" placeholder="æ•¸é‡" value="1">
                    </div>
                    <select id="gearProvider" class="form-select mb-2"><option>èª°æä¾›?</option></select>
                    <button onclick="addGear()" class="btn btn-info text-white w-100">æ–°å¢è£å‚™</button>
                </div>
            </div>

            <div class="col-md-7">
                <div class="alert alert-warning text-center shadow-sm">
                    <div class="fs-5">ç¸½æ”¯å‡º: <strong>$<span id="totalCost">0</span></strong></div>
                    <div class="text-muted small">å¹³å‡æ¯äºº: $<span id="avgCost">0</span></div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white d-flex justify-content-between">
                        <span>ğŸ§® çµç®—è¡¨</span>
                        <span style="font-size: 0.8em; opacity: 0.8;">æ­£=æ”¶éŒ¢ / è² =ä»˜éŒ¢</span>
                    </div>
                    <ul id="balanceList" class="list-group list-group-flush"></ul>
                </div>

                <div class="card p-3 bg-light">
                    <h6 class="fw-bold border-bottom pb-2">ğŸ›’ è³¼è²·æ¸…å–®</h6>
                    <ul id="expenseList" class="list-group list-group-flush small bg-transparent"></ul>
                </div>

                <div class="card p-3 bg-light mt-3">
                    <h6 class="fw-bold border-bottom pb-2">ğŸ’ è£å‚™æ¸…å–®</h6>
                    <ul id="gearList" class="list-group list-group-flush small bg-transparent"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ---------------------------------------------------------
    // ğŸ”¥ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Config
    // ---------------------------------------------------------
    const firebaseConfig = {
    apiKey: "AIzaSyDURgPj3n3Sbf1LJ9UUYdIZgogx1PB3RFA",
    authDomain: "campapp-1ef27.firebaseapp.com",
    projectId: "campapp-1ef27",
    storageBucket: "campapp-1ef27.firebasestorage.app",
    messagingSenderId: "675381855392",
    appId: "1:675381855392:web:3168fa7bd761b46d95f5c5",
    measurementId: "G-8NEWVV6BBN"
  };
    // ---------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentTripId = null;
    let currentTripData = null;

    // ç¶å®šå…¨åŸŸå‡½å¼
    window.createTrip = createTrip;
    window.showList = showList;
    window.addParticipant = addParticipant;
    window.addExpense = addExpense;
    window.addGear = addGear;
    window.togglePaid = togglePaid;
    window.deleteExpense = deleteExpense;
    window.deleteParticipant = deleteParticipant;
    window.deleteGear = deleteGear;
    window.deleteCurrentTrip = deleteCurrentTrip;

    // 1. ç›£è½åˆ—è¡¨ (åŒ…å«éæœŸåˆ¤æ–·é‚è¼¯)
    const tripListEl = document.getElementById('tripList');
    const loadingEl = document.getElementById('loading');
    
    onSnapshot(collection(db, "trips"), (snapshot) => {
        tripListEl.innerHTML = "";
        loadingEl.style.display = 'none';
        
        let trips = [];
        snapshot.forEach(doc => trips.push({id: doc.id, ...doc.data()}));
        
        // ä¾é–‹å§‹æ—¥æœŸæ’åº (æ–°åˆ°èˆŠ)
        trips.sort((a, b) => new Date(b.startDate || b.date) - new Date(a.startDate || a.date));

        const today = new Date();
        today.setHours(0,0,0,0); // åªæ¯”è¼ƒæ—¥æœŸï¼Œå¿½ç•¥æ™‚é–“

        trips.forEach(trip => {
            // ç›¸å®¹æ€§è™•ç† (èˆŠè³‡æ–™å¯èƒ½åªæœ‰ date)
            const start = trip.startDate || trip.date;
            const end = trip.endDate || trip.date; 
            
            // åˆ¤æ–·æ˜¯å¦éæœŸ
            const endDateObj = new Date(end);
            const isFinished = endDateObj < today;
            
            // è¨­å®šæ¨£å¼
            const listClass = isFinished ? 'trip-finished' : 'trip-active';
            const badgeHtml = isFinished 
                ? '<span class="badge badge-status">âœ… å·²çµæŸ</span>' 
                : '<span class="badge bg-success">â›º é€²è¡Œä¸­</span>';

            tripListEl.innerHTML += `
                <a href="#" onclick="window.loadTrip('${trip.id}')" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ${listClass}">
                    <div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-bold fs-5">${trip.location}</span>
                            ${badgeHtml}
                        </div>
                        <small class="opacity-75">ğŸ“… ${start} ~ ${end}</small>
                    </div>
                    <span class="badge bg-light text-dark border">æŸ¥çœ‹ ></span>
                </a>`;
        });
    });

    // 2. å»ºç«‹æ–°æ´»å‹• (ä¿®æ”¹ï¼šå­˜å…¥é–‹å§‹èˆ‡çµæŸæ—¥æœŸ)
    async function createTrip() {
        const start = document.getElementById('newStartDate').value;
        const end = document.getElementById('newEndDate').value;
        const loc = document.getElementById('newLoc').value;
        
        if(!start || !end || !loc) return alert("è«‹è¼¸å…¥å®Œæ•´æ—¥æœŸèˆ‡åœ°é»");
        if(start > end) return alert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ");

        const btn = document.querySelector('button[onclick="createTrip()"]');
        btn.disabled = true; btn.innerText = "å»ºç«‹ä¸­...";

        await addDoc(collection(db, "trips"), {
            startDate: start, // æ–°æ¬„ä½
            endDate: end,     // æ–°æ¬„ä½
            date: start,      // ä¿ç•™èˆŠæ¬„ä½ä»¥é˜²è¬ä¸€
            location: loc,
            participants: [], expenses: [], gears: []         
        });
        document.getElementById('newLoc').value = '';
        btn.disabled = false; btn.innerText = "å»ºç«‹æ´»å‹•";
    }

    async function deleteCurrentTrip() {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ•´å€‹æ´»å‹•ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
        await deleteDoc(doc(db, "trips", currentTripId));
        showList();
    }

    // 3. è¼‰å…¥æ´»å‹•
    window.loadTrip = function(id) {
        currentTripId = id;
        document.getElementById('page-list').style.display = 'none';
        document.getElementById('page-detail').style.display = 'block';
        window.scrollTo(0,0);

        onSnapshot(doc(db, "trips", id), (docSnap) => {
            if (!docSnap.exists()) { showList(); return; }
            currentTripData = docSnap.data();
            renderDetail();
        });
    }

    function showList() {
        document.getElementById('page-list').style.display = 'block';
        document.getElementById('page-detail').style.display = 'none';
        currentTripId = null;
    }

    function renderDetail() {
        const d = currentTripData;
        const start = d.startDate || d.date; // ç›¸å®¹èˆŠè³‡æ–™
        const end = d.endDate || d.date;

        document.getElementById('detailTitle').innerText = d.location;
        document.getElementById('detailDate').innerText = `ğŸ“… ${start} ~ ${end}`;

        // ä¸‹æ‹‰é¸å–®è™•ç†
        const payerSelect = document.getElementById('expPayer');
        const gearSelect = document.getElementById('gearProvider');
        const currentPayer = payerSelect.value;
        
        payerSelect.innerHTML = '<option disabled selected>èª°ä»˜éŒ¢?</option>';
        gearSelect.innerHTML = '<option disabled selected>èª°æä¾›?</option>';
        
        // åƒåŠ è€…åˆ—è¡¨
        const pList = document.getElementById('participantList');
        pList.innerHTML = '';
        d.participants.forEach((p, idx) => {
            pList.innerHTML += `
                <div class="btn-group btn-group-sm me-1 mb-1">
                    <span class="btn btn-outline-secondary disabled text-dark">${p.name}</span>
                    <button onclick="deleteParticipant(${idx})" class="btn btn-outline-danger btn-x">Ã—</button>
                </div>`;
            payerSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            gearSelect.innerHTML += `<option value="${p.name}">${p.name}</option>`;
        });
        if(currentPayer && currentPayer !== 'èª°ä»˜éŒ¢?') payerSelect.value = currentPayer;

        // è³¼è²·æ¸…å–®
        const expList = document.getElementById('expenseList');
        expList.innerHTML = d.expenses.length === 0 ? '<li class="list-group-item text-muted text-center">å°šç„¡æ”¯å‡º</li>' : '';
        d.expenses.forEach((e, idx) => {
            expList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent ps-0">
                    <div>
                        <button onclick="deleteExpense(${idx})" class="btn btn-sm btn-link text-danger text-decoration-none p-0 me-2">ğŸ—‘ï¸</button>
                        <span>${e.item} <small class="text-muted">(${e.payer})</small></span>
                    </div>
                    <span class="fw-bold">$${e.cost}</span>
                </li>`;
        });

        // è£å‚™æ¸…å–® (ä¿®æ”¹ï¼šé¡¯ç¤ºæ•¸é‡)
        const gList = document.getElementById('gearList');
        gList.innerHTML = d.gears.length === 0 ? '<li class="list-group-item text-muted text-center">å°šç„¡è£å‚™</li>' : '';
        d.gears.forEach((g, idx) => {
            // ç›¸å®¹èˆŠè³‡æ–™ï¼Œè‹¥ç„¡æ•¸é‡å‰‡é¡¯ç¤º 1
            const qty = g.quantity || 1;
            gList.innerHTML += `
                <li class="list-group-item bg-transparent ps-0">
                    <button onclick="deleteGear(${idx})" class="btn btn-sm btn-link text-danger text-decoration-none p-0 me-2">ğŸ—‘ï¸</button>
                    ${g.item} <span class="badge bg-secondary">x ${qty}</span> 
                    <span class="badge bg-info text-dark ms-1">${g.provider}</span>
                </li>`;
        });

        // è¨ˆç®—é‚è¼¯
        const totalCost = d.expenses.reduce((sum, e) => sum + Number(e.cost), 0);
        const peopleCount = d.participants.length;
        const avgCost = peopleCount > 0 ? totalCost / peopleCount : 0;

        document.getElementById('totalCost').innerText = totalCost;
        document.getElementById('avgCost').innerText = Math.round(avgCost);

        const balList = document.getElementById('balanceList');
        balList.innerHTML = '';
        
        d.participants.forEach((p, index) => {
            const paid = d.expenses.filter(e => e.payer === p.name).reduce((sum, e) => sum + Number(e.cost), 0);
            const balance = paid - avgCost;
            
            let balanceHtml = '';
            if (balance > 1) balanceHtml = `<span class="balance-positive">æ‡‰æ”¶ $${Math.round(balance)}</span>`;
            else if (balance < -1) balanceHtml = `<span class="balance-negative">æ‡‰ä»˜ $${Math.round(Math.abs(balance))}</span>`;
            else balanceHtml = `<span class="text-muted">å¹³å¸³</span>`;

            balList.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center px-2">
                    <div><strong>${p.name}</strong> <small class="text-muted">($${paid})</small></div>
                    <div class="text-end">
                        ${balanceHtml}
                        <div class="mt-1">
                        <button onclick="togglePaid(${index})" class="btn btn-sm ${p.status === 'paid' ? 'btn-success' : 'btn-outline-secondary'} py-0" style="font-size: 0.8rem">
                            ${p.status === 'paid' ? 'å·²çµæ¸…' : 'æœªä»˜'}
                        </button>
                        </div>
                    </div>
                </li>`;
        });
    }

    // --- è³‡æ–™å¯«å…¥é‚è¼¯ ---
    async function addParticipant() {
        const name = document.getElementById('newPerson').value;
        if(!name) return;
        await updateDoc(doc(db, "trips", currentTripId), {
            participants: arrayUnion({ name: name, status: 'unpaid' })
        });
        document.getElementById('newPerson').value = '';
    }

    async function addExpense() {
        const item = document.getElementById('expItem').value;
        const cost = document.getElementById('expCost').value;
        const payer = document.getElementById('expPayer').value;
        if(!item || !cost || payer === 'èª°ä»˜éŒ¢?') return alert("è³‡æ–™ä¸å®Œæ•´");

        await updateDoc(doc(db, "trips", currentTripId), {
            expenses: arrayUnion({ item, cost: Number(cost), payer })
        });
        document.getElementById('expItem').value = '';
        document.getElementById('expCost').value = '';
    }

    async function addGear() {
        const item = document.getElementById('gearItem').value;
        const qty = document.getElementById('gearQty').value;
        const provider = document.getElementById('gearProvider').value;
        if(!item || provider === 'èª°æä¾›?') return alert("è³‡æ–™ä¸å®Œæ•´");

        // ä¿®æ”¹ï¼šåŠ å…¥ quantity
        await updateDoc(doc(db, "trips", currentTripId), {
            gears: arrayUnion({ item, quantity: Number(qty) || 1, provider })
        });
        document.getElementById('gearItem').value = '';
        document.getElementById('gearQty').value = '1';
    }

    async function deleteItemFromArray(field, index) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™é …ç›®å—ï¼Ÿ")) return;
        const newList = [...currentTripData[field]];
        newList.splice(index, 1);
        await updateDoc(doc(db, "trips", currentTripId), { [field]: newList });
    }

    async function deleteParticipant(index) {
        const name = currentTripData.participants[index].name;
        const hasExpense = currentTripData.expenses.some(e => e.payer === name);
        if(hasExpense) return alert(`ç„¡æ³•åˆªé™¤ ${name}ï¼Œå› ç‚ºä»–é‚„æœ‰ä»˜æ¬¾ç´€éŒ„ã€‚`);
        await deleteItemFromArray('participants', index);
    }

    async function deleteExpense(index) { await deleteItemFromArray('expenses', index); }
    async function deleteGear(index) { await deleteItemFromArray('gears', index); }

    async function togglePaid(index) {
        const newParticipants = [...currentTripData.participants];
        newParticipants[index].status = newParticipants[index].status === 'paid' ? 'unpaid' : 'paid';
        await updateDoc(doc(db, "trips", currentTripId), { participants: newParticipants });
    }
</script>
</body>
</html>