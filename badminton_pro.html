<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>羽毛球活動管理系統 (進階版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .card { transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        /* 隱藏數字輸入框的箭頭 */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>

<div id="app" class="max-w-xl mx-auto min-h-screen bg-gray-50 shadow-2xl relative flex flex-col">
    
    <header class="bg-indigo-700 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-20">
        <h1 class="text-xl font-bold flex items-center"><i class="fa-solid fa-feather-pointed mr-2"></i>羽毛球小管家 Pro</h1>
        <button v-if="view !== 'list'" @click="view = 'list'" class="text-sm bg-indigo-800 px-3 py-1 rounded hover:bg-indigo-900 transition">
            <i class="fa-solid fa-arrow-left"></i> 返回
        </button>
    </header>

    <div v-if="view === 'list'" class="p-4 flex-1 overflow-y-auto pb-24">
        <div v-if="events.length === 0" class="text-center text-gray-400 mt-20">
            <i class="fa-solid fa-court text-6xl mb-4 opacity-30"></i>
            <p>暫無活動記錄</p>
        </div>

        <div v-for="event in sortedEvents" :key="event.id" @click="openEvent(event.id)" 
             class="card bg-white border-l-4 border-indigo-500 rounded-lg p-4 mb-4 cursor-pointer shadow-sm relative">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">{{ event.date }}</h3>
                    <p class="text-gray-500 text-sm"><i class="fa-solid fa-location-dot mr-1"></i> {{ event.location }}</p>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold" :class="getEventBalance(event) >= 0 ? 'text-green-600' : 'text-red-500'">
                        {{ getEventBalance(event) >= 0 ? '盈餘' : '赤字' }} ${{ Math.abs(getEventBalance(event)) }}
                    </div>
                    <span class="text-xs text-gray-400">{{ event.participants.length }} 人參加</span>
                </div>
            </div>
        </div>
    </div>

    <div v-if="view === 'create'" class="p-4 flex-1 overflow-y-auto">
        <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">新增活動</h2>
        
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">日期</label>
                    <input type="date" v-model="form.date" class="w-full mt-1 p-2 border rounded focus:border-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">地點</label>
                    <input type="text" v-model="form.location" placeholder="體育館名稱" class="w-full mt-1 p-2 border rounded focus:border-indigo-500 outline-none">
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h3 class="font-bold text-indigo-700 mb-3 text-sm flex justify-between items-center">
                    訂場記錄 (誰付了場費?)
                </h3>
                
                <div v-for="(booking, idx) in form.bookings" :key="idx" class="mb-3 pb-3 border-b last:border-0 relative">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold bg-gray-200 px-2 py-0.5 rounded text-gray-600">訂場人 #{{ idx + 1 }}</span>
                        <button v-if="form.bookings.length > 1" @click="removeBookingForm(idx)" class="text-red-400 hover:text-red-600">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-12 gap-2">
                        <div class="col-span-5">
                            <input type="text" v-model="booking.name" placeholder="姓名" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="col-span-3">
                            <select v-model.number="booking.count" class="w-full p-2 border rounded text-sm bg-white">
                                <option v-for="n in 5" :value="n">{{ n }}場</option>
                            </select>
                        </div>
                        <div class="col-span-4">
                            <select v-model.number="booking.price" class="w-full p-2 border rounded text-sm bg-white">
                                <option :value="50">@ $50</option>
                                <option :value="60">@ $60</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" :id="'join-'+idx" v-model="booking.isParticipant" class="mr-2 h-4 w-4 text-indigo-600">
                        <label :for="'join-'+idx" class="text-sm text-gray-600 select-none">他/她也是參加者 (需付$70)</label>
                    </div>
                </div>

                <button @click="addBookingForm" class="w-full py-2 border-2 border-dashed border-indigo-200 text-indigo-500 rounded hover:bg-indigo-50 font-bold text-sm">
                    <i class="fa-solid fa-plus mr-1"></i> 增加另一位訂場人
                </button>
            </div>

            <button @click="createEvent" :disabled="!isFormValid" 
                class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                建立活動
            </button>
        </div>
    </div>

    <div v-if="view === 'detail' && currentEvent" class="p-4 flex-1 overflow-y-auto pb-24">
        
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">{{ currentEvent.date }}</h2>
                <p class="text-gray-500"><i class="fa-solid fa-map-pin"></i> {{ currentEvent.location }}</p>
            </div>
            <button @click="deleteEvent(currentEvent.id)" class="text-gray-400 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
        </div>

        <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-xl p-4 shadow-lg mb-6">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">活動財務總覽</h3>
            <div class="grid grid-cols-3 gap-2 text-center divide-x divide-slate-700">
                <div>
                    <div class="text-xs text-slate-400">總場費支出</div>
                    <div class="text-lg font-bold">${{ currentFinancials.totalCost }}</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400">總預期收入</div>
                    <div class="text-lg font-bold">${{ currentFinancials.totalIncome }}</div>
                    <div class="text-[10px] text-slate-500">{{ currentEvent.participants.length }}人 x $70</div>
                </div>
                <div>
                    <div class="text-xs text-slate-400">活動結餘</div>
                    <div :class="currentFinancials.balance >= 0 ? 'text-emerald-400' : 'text-red-400'" class="text-lg font-bold">
                        {{ currentFinancials.balance >= 0 ? '+' : ''}}{{ currentFinancials.balance }}
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold text-gray-800 mb-2 flex items-center">
                <i class="fa-solid fa-file-invoice-dollar mr-2 text-indigo-600"></i> 訂場人結算
                <span class="text-xs font-normal text-gray-500 ml-2">(正數=取回錢 / 負數=補付錢)</span>
            </h3>
            <div class="space-y-2">
                <div v-for="(settlement, idx) in bookerSettlements" :key="idx" 
                     class="bg-white border rounded-lg p-3 flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold text-gray-800">
                            {{ settlement.name }}
                            <span v-if="!settlement.isParticipant" class="text-[10px] bg-gray-200 text-gray-600 px-1 rounded ml-1">非參加者</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-0.5">
                            墊支場費: ${{ settlement.paidForCourts }} | 
                            <span v-if="settlement.isParticipant">參加費: -$70</span>
                            <span v-else>參加費: $0</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold" :class="settlement.netAmount >= 0 ? 'text-green-600' : 'text-red-600'">
                            {{ settlement.netAmount >= 0 ? '+' : '' }}{{ settlement.netAmount }}
                        </div>
                        <div class="text-[10px] text-gray-400">
                            {{ settlement.netAmount >= 0 ? '應取回' : '需補付' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="font-bold text-gray-800 mb-2 flex justify-between items-center">
                <span>參加人員 ({{ currentEvent.participants.length }})</span>
                <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">已收: ${{ collectedAmount }}</span>
            </h3>
            
            <div class="space-y-2">
                <div v-for="(p, idx) in currentEvent.participants" :key="idx" 
                     class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                    <div class="flex items-center">
                        <div v-if="isPersonBooker(p.name)" class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mr-3 text-xs font-bold shadow-sm">訂</div>
                        <div v-else class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center mr-3"><i class="fa-solid fa-user"></i></div>
                        <span :class="{'font-semibold text-indigo-900': isPersonBooker(p.name)}">{{ p.name }}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button @click="togglePaid(p)" 
                            :class="p.isPaid ? 'bg-green-500 text-white shadow-green-200' : 'bg-gray-200 text-gray-400'"
                            class="w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-sm">
                            <i class="fa-solid fa-check"></i>
                        </button>
                        <button @click="removeParticipant(idx)" class="text-gray-300 hover:text-red-500 px-1">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <input type="text" v-model="newParticipantName" @keyup.enter="addParticipant" placeholder="輸入名字..." 
                       class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none shadow-sm">
                <button @click="addParticipant" class="bg-indigo-600 text-white px-5 rounded-lg hover:bg-indigo-700 shadow font-bold">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <button v-if="view === 'list'" @click="view = 'create'" 
            class="absolute bottom-8 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-300 flex items-center justify-center text-2xl hover:scale-110 transition-transform z-20">
        <i class="fa-solid fa-plus"></i>
    </button>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const view = ref('list');
            const events = ref([]);
            const currentEventId = ref(null);
            
            // 表單數據
            const form = ref({
                date: new Date().toISOString().split('T')[0],
                location: '',
                // 訂場人列表 (可多人)
                bookings: [
                    { name: '', count: 1, price: 50, isParticipant: true }
                ]
            });
            
            const newParticipantName = ref('');

            // 持久化存儲
            onMounted(() => {
                const saved = localStorage.getItem('badminton_pro_events');
                if (saved) events.value = JSON.parse(saved);
            });
            watch(events, (val) => localStorage.setItem('badminton_pro_events', JSON.stringify(val)), { deep: true });

            // 核心邏輯
            const currentEvent = computed(() => events.value.find(e => e.id === currentEventId.value));
            
            const sortedEvents = computed(() => [...events.value].sort((a, b) => new Date(b.date) - new Date(a.date)));

            // 計算活動的當前財務 (用於列表頁顯示盈虧)
            const getEventBalance = (event) => {
                const totalCost = event.bookings.reduce((sum, b) => sum + (b.count * b.price), 0);
                const totalIncome = event.participants.length * 70;
                return totalIncome - totalCost;
            };

            // 計算當前頁面的詳細財務
            const currentFinancials = computed(() => {
                if (!currentEvent.value) return { totalCost: 0, totalIncome: 0, balance: 0 };
                const totalCost = currentEvent.value.bookings.reduce((sum, b) => sum + (b.count * b.price), 0);
                const totalIncome = currentEvent.value.participants.length * 70;
                return {
                    totalCost,
                    totalIncome,
                    balance: totalIncome - totalCost
                };
            });

            // 已收到的現金 (只計算已標記付款的非訂場人 + 訂場人如果需要補付的部分通常是內部結算，這裡只算純現金流的"已收")
            // 這裡簡化為：所有打勾的人頭費總和。
            // 但實際操作上，訂場人通常不給現金，而是扣除墊支。
            // 這裡顯示「從參加者收到的總費」比較直觀。
            const collectedAmount = computed(() => {
                 if (!currentEvent.value) return 0;
                 return currentEvent.value.participants.filter(p => p.isPaid).length * 70;
            });

            // *** 核心計算：訂場人結算表 ***
            const bookerSettlements = computed(() => {
                if (!currentEvent.value) return [];
                
                return currentEvent.value.bookings.map(booking => {
                    // 1. 他墊支了多少?
                    const paidForCourts = booking.count * booking.price;
                    
                    // 2. 他是否在參加名單中? (用名字匹配)
                    const isParticipantReal = currentEvent.value.participants.some(p => p.name === booking.name);
                    
                    // 3. 應付參加費
                    const fee = isParticipantReal ? 70 : 0;
                    
                    // 4. 淨額: (墊支 - 應付)
                    // 正數 = 活動欠他 (他要拿回)
                    // 負數 = 他欠活動 (他要補付)
                    return {
                        name: booking.name,
                        paidForCourts: paidForCourts,
                        isParticipant: isParticipantReal,
                        netAmount: paidForCourts - fee
                    };
                });
            });

            const isFormValid = computed(() => {
                return form.value.date && form.value.location && 
                       form.value.bookings.every(b => b.name && b.count > 0);
            });

            // 檢查某人是否是訂場人
            const isPersonBooker = (name) => {
                if (!currentEvent.value) return false;
                return currentEvent.value.bookings.some(b => b.name === name);
            }

            // 操作方法
            const addBookingForm = () => {
                form.value.bookings.push({ name: '', count: 1, price: 50, isParticipant: true });
            };

            const removeBookingForm = (idx) => {
                form.value.bookings.splice(idx, 1);
            };

            const createEvent = () => {
                const participants = [];
                // 自動將勾選 "是參加者" 的訂場人加入參加名單
                form.value.bookings.forEach(b => {
                    if (b.isParticipant) {
                        participants.push({ name: b.name, isPaid: false }); // 訂場人默認未付(透過結算處理)
                    }
                });

                const newEvent = {
                    id: Date.now(),
                    date: form.value.date,
                    location: form.value.location,
                    bookings: JSON.parse(JSON.stringify(form.value.bookings)), // Deep copy
                    participants: participants
                };
                
                events.value.push(newEvent);
                // Reset Form
                form.value = {
                    date: new Date().toISOString().split('T')[0],
                    location: '',
                    bookings: [{ name: '', count: 1, price: 50, isParticipant: true }]
                };
                view.value = 'list';
            };

            const openEvent = (id) => {
                currentEventId.value = id;
                view.value = 'detail';
            };

            const addParticipant = () => {
                if(!newParticipantName.value.trim()) return;
                currentEvent.value.participants.push({
                    name: newParticipantName.value.trim(),
                    isPaid: false
                });
                newParticipantName.value = '';
            };

            const removeParticipant = (idx) => {
                const p = currentEvent.value.participants[idx];
                if(isPersonBooker(p.name)) {
                    if(!confirm(`"${p.name}" 是訂場人，移除他會影響結算金額。\n確定移除嗎？(他將變為只訂場不打球)`)) return;
                }
                currentEvent.value.participants.splice(idx, 1);
            };

            const togglePaid = (p) => p.isPaid = !p.isPaid;

            const deleteEvent = (id) => {
                if(confirm('確定刪除此活動？')) {
                    events.value = events.value.filter(e => e.id !== id);
                    view.value = 'list';
                }
            };

            return {
                view, events, form, currentEvent, sortedEvents, newParticipantName,
                bookerSettlements, currentFinancials, collectedAmount, isFormValid,
                addBookingForm, removeBookingForm, createEvent, openEvent, 
                addParticipant, removeParticipant, togglePaid, deleteEvent, getEventBalance, isPersonBooker
            };
        }
    }).mount('#app');
</script>
</body>
</html>